---
title: 【C++】空间管理
published: 2024-08-20
description: "这里介绍了现代C++（C++11-C++23）的一些特性，方便从C语言过渡到C++"
image: ""
tags: ["C++"]
category: 编程
draft: false
---

在程序运行中，电脑的内存空间是有限的，因此我们要对内存进行管理，使得程序运行时不会因为内存不足而崩溃，尤其是避免内存泄漏的问题。


## 内存存储区域

C++中，内存存储区域主要有以下几种：
* **静态存储区域**  
  静态存储区域用来存储全局变量和静态变量（如静态局部变量和静态成员变量）等。这些内存空间在程序编译完成时就已经分配好，并在程序结束时被销毁，变量的生命周期存在于程序运行期间。
* **栈空间**  
  栈空间用来存储局部变量（不包括`static`修饰的局部变量）、函数参数等。这些变量在函数调用结束后会被销毁，生命周期只存在于函数调用期间。栈空间的管理由编译器自动完成。
* **堆空间**  
  堆是用来动态分配内存的区域，程序员可以通过`new`或`malloc`等函数来请求分配内存，并通过`delete`或`free`来释放内存。堆内存的生命周期由程序控制。

:::note[注意]
栈空间和堆空间之间有些区别：
* 栈空间是编译器自动管理的，而堆空间是程序员手动管理的。栈空间在函数调用结束后会自动销毁，而堆空间需要程序员手动释放
* 栈空间的大小通常是固定的，而堆空间的大小受限于内存限制
```c++
void Demo() {
    int *p = nullptr; // 申请一个栈空间 p
    p = new int[5]; // 申请一个堆空间 int [5]
    delete[] p; // 释放堆空间 int[5]
} // 销毁栈空间 p
```
:::

## 栈空间

在C++中，代码块是一种特殊的语句块，用于定义一个代码块，代码块中的语句会按照顺序执行。代码块由花括号 `{ }` 包含，并且可以嵌套在其他代码块中。代码块可以包含任何类型的语句，包括变量声明、函数调用、条件语句、循环语句等。  
代码块里面的变量声明和函数调用，会在代码块结束后被销毁，生命周期只存在于代码块中。
> 代码块里产生的变量存在于栈空间里，会随着代码块的结束而销毁。
```c++
void Dem() {
    int a = 1;
    {
        int b = 2;
    } // b 会被销毁
} // a 会被销毁
```

## 堆空间

### 使用库函数
我们可以使用`cstdlib`的`malloc`和`free`函数来申请和释放堆空间。
```c++
#include <cstdlib>

void Demo() {
  void *buffer = std::malloc(64); // 申请64 bytes 的堆空间
  if (buffer != nullptr) { // 判断堆空间是否申请成功
    // TODO 使用 buffer
    std::free(buffer); // 使用完要进行释放
  } else {
    // TODO 异常操作
  }
}
```